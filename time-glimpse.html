<link rel="import" href="../polymer/polymer-element.html">
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../l2t-paper-slider/l2t-paper-slider.html">

<link rel="import" href="report-el.html">
<link rel="import" href="annotate-outliers.html">
<link rel="import" href="chart-calendar.html">
<link rel="import" href="chart-scatter.html">
<link rel="import" href="chart-scatter-controls.html">
<link rel="import" href="chart-traditionalscatter.html">
<!-- 
`<time-glimpse>` builds glimpses of your time data.

**Usage**

Throw an array of datetimes to get back a glimpse of your data.
```html
<time-glimpse datetimes="[[datetimes]]"></time-glimpse>
```
```js
const datetimes = ['2017-08-11T14:17', '2017-08-07T16:00','2017-08-23T15:22', '2017-09-13T14:48'];
```

Weekdays patterns can be glimpsed at the calendar glimpse: a repeated weekday pattern forms a line.

Time patterns can be glimpsed at the scatter glimpse: a repeated time pattern approaches a line format.

Frequency patterns can be glimpsed both at the calendar and scatter glimpses: every month, twice a week, mostly random.

Expect more glimpses to be added in the future.
-->

<dom-module id="time-glimpse">
  <template>
    <style>
      :host {
        display: block;
        @apply --time-glimpse-mixin;
        --time-glimpse-main-color: var(--dark-primary-color, #4286f4);
        --time-glimpse-light-color: var(--light-primary-color, #d6e5ff);
        --paper-tab-ink: var(--time-glimpse-light-color);
        --paper-tabs-selection-bar-color: var(--time-glimpse-main-color);
        --iron-icon-fill-color: var(--time-glimpse-main-color);

        --paper-slide-dot: var(--time-glimpse-light-color);
        --paper-slide-dot-selected: var(--time-glimpse-main-color);
        --paper-slide-height: 550px;

        --time-glimpse-height: 550px;
        height: var(--time-glimpse-height);
      }

      /* #timeline {
        width: 100%;
        height: 20%;
        min-height: 50px;
        margin-bottom: 50px;
      } */

      #calendar_chart_div, #scatter_chart_div {
        margin: 0 auto;
        width: 100%;
        /* width: 90%; 
        height: 20%; */
        /* width: 900px; 
        height: 500px; */
      }
      @media screen and (min-width: 1200px) {
        #calendar_chart_div, #scatter_chart_div {
          width: 1200px;
        }
      }

      chart-scatter-controls {
        display: flex;
        justify-content: center;
      }
      paper-tabs {
        text-align: center;
      }
    </style>

    <!-- <l2t-paper-slider total-slides="2">
      <paper-slide>
        <chart-calendar chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]"></chart-calendar>        
      </paper-slide>
      <paper-slide>
        <chart-scatter-controls expanded="{{expanded}}" fullscreen="{{fullscreen}}"></chart-scatter-controls>
        <chart-scatter 
          expanded="[[expanded]]" fullscreen="[[fullscreen]]"
          chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]">
        </chart-scatter>    
      </paper-slide>
      <paper-slide>
        <chart-scatter-controls expanded="{{expandedTrad}}" fullscreen="{{fullscreen}}"></chart-scatter-controls>
        <chart-traditionalscatter
            expanded="[[expandedTrad]]" fullscreen="[[fullscreen]]"
            chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]">
        </chart-traditionalscatter>        
      </paper-slide>
    </l2t-paper-slider> -->

    <report-el timeline-data="[[timelineData]]" report="{{report}}"></report-el>
    <annotate-outliers timeline-data="{{timelineData}}"></annotate-outliers>

    <paper-toggle-button checked="{{showOutliers}}">Outliers</paper-toggle-button>
    

    <paper-tabs selected="{{selected}}"  scrollable="true">
      <paper-tab><iron-icon icon="myicons:date-range"></iron-icon></paper-tab>
      <paper-tab><iron-icon icon="myicons:access-time"></iron-icon></paper-tab>
    </paper-tabs>

    <iron-pages selected="{{selected}}">
      <div>
        <chart-calendar 
        show-outliers="[[showOutliers]]"
        chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]" height="{{calendarHeight}}"></chart-calendar>        
      </div>
      <div>
        <chart-scatter
        show-outliers="[[showOutliers]]"
        expanded="[[expanded]]" fullscreen="[[fullscreen]]"
        chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]">
      </chart-scatter>    
      <chart-scatter-controls expanded="{{expanded}}" fullscreen="{{fullscreen}}"></chart-scatter-controls>
      </div>
      <div>
        <chart-scatter-controls expanded="{{expandedTrad}}" fullscreen="{{fullscreen}}"></chart-scatter-controls>
        <chart-traditionalscatter
            expanded="[[expandedTrad]]" fullscreen="[[fullscreen]]"
            chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]">
        </chart-traditionalscatter>        
      </div>
    </iron-pages>

  </template>

  <script>
    /**
    * `time-glimpse`
    * A timeline to display dates
    *
    * @customElement
    * @polymer
    * @demo demo/index.html
    */
    class TimeAnalysis extends Polymer.Element {
      static get is() { return 'time-glimpse'; }
      static get observers() {
        return [
          'observeCalendarHeight(calendarHeight)',
        ];
      }
      static get properties() {
        return {
          selected: {
            type: Number,
            value: 0,
          },
          showOutliers: {
            type: Boolean,
            value: true,
          },

          /**
          * Array of datetimes to be plotted.
          */
          datetimes: {
            type: Array,
            value: null,
          },
          timelineData: {
            type: Array,
            computed: 'computeTimelineData(datetimes)',
          },          
          report: {
            type: Object,
          },          
          hostWidth: {
            type: Number,
          },
          chartMainStyles: {
            type: Object,
            computed: 'computeChartMainStyles(hostWidth)',
          },
        };
      }

      connectedCallback() {
        super.connectedCallback();
        // console.log(window.innerWidth);
        this.set('hostWidth', this.offsetWidth);
        console.log(this.hostWidth);
      }

      observeCalendarHeight(calendarHeight) {
        console.log(calendarHeight)
        this.updateStyles({'--time-glimpse-height': `${calendarHeight}px`});
      }

      computeChartMainStyles(hostWidth) {
        // dimensions
        const chartWidth = (hostWidth > 1200) ? 1200 : Math.round(hostWidth) - 15;
        
        //colors
        let mainColor, lightMainColor;
        if (ShadyCSS) {
          mainColor = ShadyCSS.getComputedStyleValue(this, '--time-glimpse-main-color');
          lightMainColor = ShadyCSS.getComputedStyleValue(this, '--time-glimpse-light-color');
        } else {
          mainColor = getComputedStyle(this).getPropertyValue('--time-glimpse-main-color');
          lightMainColor = getComputedStyle(this).getPropertyValue('--time-glimpse-light-color');
        }
        const dataColor = mainColor; //'#4286f4'; 
        const lightColor = lightMainColor; //'#d6e5ff';
        return { chartWidth, dataColor, lightColor };
      }

      computeTimelineData(datetimes) {
        if (!datetimes || !datetimes[0]) return;
        const timelineData = datetimes
          .map(dt => this._toDateTime(dt))
          .map((dt, index) => {
            // console.log(dt)
            const time = this._getTime(dt);
            const date = this._getDate(dt);
            return {
              datetime: dt,
              weekday: this._getWeekDay(dt),
              time: time,
              timeVal: this._timeToNumberScale(time),
              formattedDate: this._formattedDate(dt),
              date: date,
              dateVal: this._dateToNumberScale(date)
            }
          });

        // console.log(timelineData)  
        return timelineData;        
      }

      _timeToNumberScale(time) {
        var hoursMinutes = time.split(/[.:]/);
        var hours = parseInt(hoursMinutes[0], 10);
        var minutes = hoursMinutes[1] ? parseInt(hoursMinutes[1], 10) : 0;
        // return parseFloat(`${hours}.${minutes}`);        
        return hours + minutes / 60;        
      }

      _dateToNumberScale(strDate) {
        var date = new Date(strDate);
        var days = date.getDate();
        var months = date.getMonth() + 1;
        var years = date.getFullYear();
        // console.log(strDate, date, days, months, years)
        return days / 12 + months + years * 12;        
      }

      _toDateTime(date) {
        return new Date(date);
      }

      _getDate(date) {
        if (!date) return;
        //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DateTimeFormat
        // var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        var options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const dateFormat = new Intl.DateTimeFormat(window.navigator.language, options);
        return dateFormat.format(date);        
      }

      _getTime(date) {
        return date.toLocaleString('pt-BR').substring(11,16).trim();
      }

      _getWeekDay(date) {
        //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DateTimeFormat
        const weekdayFormat = new Intl.DateTimeFormat(window.navigator.language, { 
          weekday: 'short', 
        });
        return weekdayFormat.format(date).toLocaleLowerCase();
      }

      _formattedDate(date) {
        if (!date) return;
        const lang = window.Intl || 'en';
        //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DateTimeFormat
        const textDateFormat = new Intl.DateTimeFormat(lang, { 
          year: 'numeric',
          month: 'long', 
          day: 'numeric', 
        });

        return textDateFormat.format(date);
      }

      // function showOutliers(someArray) {

      //   if(someArray.length < 4)
      //     return someArray;

      //   let values, q1, q3, iqr, maxValue, minValue;

      //   values = someArray.slice().sort( (a, b) => a - b);//copy array fast and sort

      //   if((values.length / 4) % 1 === 0){//find quartiles
      //     q1 = 1/2 * (values[(values.length / 4)] + values[(values.length / 4) + 1]);
      //     q3 = 1/2 * (values[(values.length * (3 / 4))] + values[(values.length * (3 / 4)) + 1]);
      //   } else {
      //     q1 = values[Math.floor(values.length / 4 + 1)];
      //     q3 = values[Math.ceil(values.length * (3 / 4) + 1)];
      //   }

      //   iqr = q3 - q1;
      //   maxValue = q3 + iqr * 1.5;
      //   minValue = q1 - iqr * 1.5;
      //   console.log(q1, q3, iqr, maxValue, minValue);

      //   return values.filter((x) => (x >= minValue) && (x <= maxValue));
      // }

      jsonStringify(obj) {
        return JSON.stringify(obj, null, 2);
      }


    }


    window.customElements.define(TimeAnalysis.is, TimeAnalysis);
  </script>
</dom-module>
